<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>海洋管理系统 - 智能中心</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="css/style.css">
    <style>
        body, html {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        .d-flex.flex-column.vh-100 {
            height: 100vh;
        }

        main.flex-grow-1 {
            overflow-y: auto;
        }

        @media (min-width: 768px) {
            .offcanvas-start.sidebar {
                position: static;
                transform: none;
                visibility: visible !important;
                width: 445px;
                height: 100vh;
                border-right: 1px solid rgba(255, 255, 255, 0.1);
            }
        }
    </style>
</head>

<body>
    <!-- 移动端顶部导航栏 -->
    <nav class="navbar navbar-dark bg-dark d-md-none">
        <div class="container-fluid">
            <button class="navbar-toggler" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebarOffcanvas" aria-controls="sidebarOffcanvas">
                <span class="navbar-toggler-icon"></span>
            </button>
            <span class="navbar-brand mb-0 h1">海洋管理系统</span>
        </div>
    </nav>
        <div class="container-fluid">
            <div class="d-flex">
                <!-- 响应式侧边栏 -->
                <div class="offcanvas offcanvas-start bg-dark text-white sidebar" tabindex="-1" id="sidebarOffcanvas">
                    <div class="offcanvas-header d-md-none">
                        <h5 class="offcanvas-title">菜单导航</h5>
                        <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas"></button>
                    </div>
                    <div class="offcanvas-body p-3">
                        <div class="text-center mb-4">
                            <h5 class="text-white">海洋管理系统</h5>
                            <p class="text-white-50" id="userInfo">
                                欢迎，<span id="currentUser">{{ username }}</span>
                            </p>
                        </div>
                        <ul class="nav flex-column">
                            <li class="nav-item">
                                <a class="nav-link text-white" href="{{ url_for('main.user_dashboard') }}">
                                    <i class="bi bi-speedometer2 me-2"></i>主要信息
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link active text-white" href="{{ url_for('main.underwater') }}">
                                    <i class="bi bi-water me-2"></i>水下系统
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link text-white" href="{{ url_for('main.intelligence') }}">
                                    <i class="bi bi-cpu me-2"></i>智能中心
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link text-white" href="{{ url_for('main.admin_page') }}">
                                    <i class="bi bi-gear me-2"></i>管理员管理
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link text-white" href="{{ url_for('main.datacenter') }}">
                                    <i class="bi bi-database me-2"></i>数据中心
                                </a>
                            </li>
                            <li class="nav-item mt-5">
                                <a class="nav-link text-white" href="{{ url_for('auth.logout') }}">
                                    <i class="bi bi-box-arrow-right me-2"></i>退出登录
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            <!-- 侧边栏结束 -->
            <!-- 主内容区域 -->
            <main class="flex-grow-1 px-3 mt-3">
                <div
                    class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">智能中心</h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <button type="button" class="btn btn-sm btn-outline-primary me-2">
                            <i class="bi bi-gear"></i> 系统设置
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary">
                            <i class="bi bi-question-circle"></i> 帮助
                        </button>
                    </div>
                </div>

                <!-- 智能问答模块 -->
                <div class="row mb-4">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header bg-info text-white">
                                <h5><i class="bi bi-chat-dots-fill me-2"></i>智能问答助手</h5>
                                <small>基于豆包AI的海洋牧场智能问答系统</small>
                            </div>
                            <div class="card-body">
                                <!-- API Key 配置区域 -->
                                <div class="alert alert-info mb-3">
                                    <div class="row align-items-center">
                                        <div class="col-md-8">
                                            <label for="doubaoApiKey" class="form-label"><strong>豆包API Key配置:</strong></label>
                                            <input type="password" class="form-control" id="doubaoApiKey" placeholder="请输入您的豆包API Key">
                                            <small class="form-text text-muted">请在此处输入您的豆包API Key以启用智能问答功能</small>
                                        </div>
                                        <div class="col-md-4">
                                            <button type="button" class="btn btn-primary" id="saveApiKey">
                                                <i class="bi bi-check-circle"></i> 保存配置
                                            </button>
                                            <div class="mt-2">
                                                <span class="badge bg-secondary" id="apiKeyStatus">未配置</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 聊天界面 -->
                                <div class="chat-container" style="height: 400px; border: 1px solid #dee2e6; border-radius: 0.375rem; overflow-y: auto; padding: 15px; background-color: #f8f9fa;" id="chatContainer">
                                    <div class="welcome-message text-center text-muted mt-5">
                                        <i class="bi bi-robot" style="font-size: 3rem;"></i>
                                        <h5 class="mt-3">海洋牧场智能助手</h5>
                                        <p>您好！我是您的海洋牧场智能助手，可以为您解答关于水质管理、鱼类养殖、设备维护等问题。</p>
                                        <p class="text-warning"><small>请先配置豆包API Key以开始对话</small></p>
                                    </div>
                                </div>
                                
                                <!-- 输入区域 -->
                                <div class="input-group mt-3">
                                    <input type="text" class="form-control" id="userQuestion" placeholder="请输入您的问题..." disabled>
                                    <button class="btn btn-primary" type="button" id="sendQuestion" disabled>
                                        <i class="bi bi-send"></i> 发送
                                    </button>
                                </div>
                                
                                <!-- 快捷问题 -->
                                <div class="mt-3">
                                    <small class="text-muted">快捷问题:</small>
                                    <div class="mt-2">
                                        <button class="btn btn-sm btn-outline-secondary me-2 mb-2 quick-question" data-question="当前水质状况如何？">当前水质状况如何？</button>
                                        <button class="btn btn-sm btn-outline-secondary me-2 mb-2 quick-question" data-question="鱼类生长情况怎么样？">鱼类生长情况怎么样？</button>
                                        <button class="btn btn-sm btn-outline-secondary me-2 mb-2 quick-question" data-question="有什么设备需要维护吗？">有什么设备需要维护吗？</button>
                                        <button class="btn btn-sm btn-outline-secondary me-2 mb-2 quick-question" data-question="如何优化养殖效率？">如何优化养殖效率？</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 智能鱼类识别模块 -->
                <div class="row mb-4">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header bg-info text-white">
                                <h5><i class="bi bi-camera-fill me-2"></i>智能鱼类识别</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <!-- 图片上传区域 -->
                                        <div class="upload-area" style="border: 2px dashed #dee2e6; border-radius: 0.375rem; padding: 40px; text-align: center; background-color: #f8f9fa; cursor: pointer;" id="uploadArea">
                                            <i class="bi bi-cloud-upload" style="font-size: 3rem; color: #6c757d;"></i>
                                            <h5 class="mt-3 text-muted">点击或拖拽上传鱼类图片</h5>
                                            <p class="text-muted">支持 JPG、PNG、JPEG 格式，最大 10MB</p>
                                            <input type="file" id="fishImageInput" accept="image/*" style="display: none;">
                                        </div>
                                        
                                        <!-- 图片预览 -->
                                        <div class="mt-3" id="imagePreview" style="display: none;">
                                            <img id="previewImage" class="img-fluid rounded" style="max-height: 300px; width: 100%; object-fit: contain;">
                                            <div class="mt-2">
                                                <button class="btn btn-primary" id="analyzeButton">
                                                    <i class="bi bi-search"></i> 开始识别
                                                </button>
                                                <button class="btn btn-secondary ms-2" id="clearButton">
                                                    <i class="bi bi-trash"></i> 清除
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <!-- 识别结果 -->
                                        <div class="result-area">
                                            <h6 class="mb-3">识别结果</h6>
                                            <div id="recognitionResult" class="p-3 bg-light rounded" style="min-height: 200px;">
                                                <div class="text-center text-muted mt-5">
                                                    <i class="bi bi-fish" style="font-size: 2rem;"></i>
                                                    <p class="mt-2">请上传鱼类图片进行识别</p>
                                                </div>
                                            </div>
                                            
                                            <!-- 识别历史 -->
                                            <div class="mt-3">
                                                <h6>识别历史</h6>
                                                <div id="recognitionHistory" class="" style="max-height: 200px; overflow-y: auto;">
                                                    <p class="text-muted text-center">暂无识别记录</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 功能说明 -->
                                <div class="row mt-4">
                                    <div class="col-md-12">
                                        <div class="alert alert-info">
                                            <h6><i class="bi bi-info-circle me-2"></i>功能说明</h6>
                                            <ul class="mb-0">
                                                <li>支持识别常见海洋鱼类品种（鲈鱼、武昌鱼、狗鱼等）</li>
                                                <li>基于深度学习模型预测鱼类体长</li>
                                                <li>提供鱼类健康状况评估</li>
                                                <li>自动记录识别历史便于追踪</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 智能预测模块 -->
                <div class="row mb-4">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header">
                                <h5>智能预测分析</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="card mb-3">
                                            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                                                <span><i class="bi bi-droplet-fill me-2"></i>水质趋势预测</span>
                                                <button class="btn btn-sm btn-light" id="downloadWaterPredictionBtn">
                                                    <i class="bi bi-download"></i> 导出图表
                                                </button>
                                            </div>
                                            <div class="card-body">
                                                <canvas id="waterQualityPredictionChart"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card mb-3">
                                            <div class="card-header bg-success text-white">
                                                鱼类数量预测
                                            </div>
                                            <div class="card-body">
                                                <canvas id="fishPopulationPredictionChart"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 异常检测模块 -->
                <div class="row mb-4">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header">
                                <h5>异常检测系统</h5>
                            </div>
                            <div class="card-body">
                                <div class="alert alert-warning" role="alert">
                                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                    <strong>注意:</strong> 系统检测到3个潜在异常，请查看详情。
                                </div>
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>时间</th>
                                            <th>类型</th>
                                            <th>位置</th>
                                            <th>详情</th>
                                            <th>状态</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr class="table-danger">
                                            <td>2023-11-15 08:23</td>
                                            <td>水质异常</td>
                                            <td>区域A-3</td>
                                            <td>pH值突然下降至6.2</td>
                                            <td><span class="badge bg-danger">未处理</span></td>
                                            <td>
                                                <button class="btn btn-sm btn-primary">处理</button>
                                                <button class="btn btn-sm btn-secondary">详情</button>
                                            </td>
                                        </tr>
                                        <tr class="table-warning">
                                            <td>2023-11-15 07:45</td>
                                            <td>设备异常</td>
                                            <td>区域B-2</td>
                                            <td>水下摄像头UW002信号不稳定</td>
                                            <td><span class="badge bg-warning">处理中</span></td>
                                            <td>
                                                <button class="btn btn-sm btn-primary">处理</button>
                                                <button class="btn btn-sm btn-secondary">详情</button>
                                            </td>
                                        </tr>
                                        <tr class="table-warning">
                                            <td>2023-11-14 22:10</td>
                                            <td>鱼群异常</td>
                                            <td>区域C-5</td>
                                            <td>鱼群密度异常增加</td>
                                            <td><span class="badge bg-warning">处理中</span></td>
                                            <td>
                                                <button class="btn btn-sm btn-primary">处理</button>
                                                <button class="btn btn-sm btn-secondary">详情</button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 智能预测分析部分 -->
                <div class="row">
                    <div class="col-md-12">
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5>智能预测分析</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <!-- 水质趋势预测 -->
                                    <div class="col-md-6">
                                        <div class="card mb-3">
                                            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                                                <span><i class="bi bi-droplet-fill me-2"></i>水质趋势预测</span>
                                                <div>
                                                    <div class="btn-group">
                                                        <button class="btn btn-sm btn-light" id="waterQualityDay">日</button>
                                                        <button class="btn btn-sm btn-light" id="waterQualityWeek">周</button>
                                                        <button class="btn btn-sm btn-light" id="waterQualityMonth">月</button>
                                                    </div>
                                                    <button class="btn btn-sm btn-light ms-2" id="downloadWaterPrediction">
                                                        <i class="bi bi-download"></i>
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="card-body">
                                                <canvas id="waterQualityPredictionChart" height="250"></canvas>
                                                <div class="mt-3">
                                                    <div class="alert alert-info">
                                                        <h6><i class="bi bi-info-circle-fill me-2"></i>预测结果分析</h6>
                                                        <p>根据历史数据分析，未来7天内水质参数预计将保持稳定，pH值可能在6月15日出现小幅波动，建议提前做好水质调节准备。</p>
                                                    </div>
                                                    <div class="d-flex justify-content-between">
                                                        <span class="badge bg-success">可信度: 87%</span>
                                                        <button class="btn btn-sm btn-outline-primary" id="exportWaterPrediction">
                                                            <i class="bi bi-download"></i> 导出预测报告
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- 鱼类数量预测 -->
                                    <div class="col-md-6">
                                        <div class="card mb-3">
                                        <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                                            <span><i class="bi bi-bar-chart-fill me-2"></i>鱼类数量预测</span>
                                            <div>
                                                <div class="btn-group">
                                                    <button class="btn btn-sm btn-light" id="fishCountQuarter">季度</button>
                                                    <button class="btn btn-sm btn-light" id="fishCountHalfYear">半年</button>
                                                    <button class="btn btn-sm btn-light" id="fishCountYear">年</button>
                                                </div>
                                                <button class="btn btn-sm btn-light ms-2" id="downloadFishCountPrediction">
                                                    <i class="bi bi-download"></i>
                                                </button>
                                            </div>
                                        </div>
                                            <div class="card-body">
                                                <canvas id="fishCountPredictionChart" height="250"></canvas>
                                                <div class="mt-3">
                                                    <div class="alert alert-success">
                                                        <h6><i class="bi bi-info-circle-fill me-2"></i>预测结果分析</h6>
                                                        <p>基于生长模型预测，鲈鱼数量将在8月达到收获标准，预计产量较去年同期增长12%，建议提前规划收获计划。</p>
                                                    </div>
                                                    <div class="d-flex justify-content-between">
                                                        <span class="badge bg-success">可信度: 83%</span>
                                                        <button class="btn btn-sm btn-outline-success" id="exportFishPrediction">
                                                            <i class="bi bi-download"></i> 导出预测报告
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 异常检测系统 -->
                                <div class="row mt-4">
                                    <div class="col-md-12">
                                        <div class="card">
                                            <div class="card-header bg-warning text-dark">
                                                <h5><i class="bi bi-exclamation-triangle-fill me-2"></i>异常检测系统</h5>
                                            </div>
                                            <div class="card-body">
                                                <div class="alert alert-warning mb-3">
                                                    <strong>注意: </strong>系统检测到3个潜在异常，请查看详情。
                                                </div>
                                                <div class="table-responsive">
                                                    <table class="table table-striped table-hover">
                                                        <thead>
                                                            <tr>
                                                                <th>时间</th>
                                                                <th>类型</th>
                                                                <th>位置</th>
                                                                <th>详情</th>
                                                                <th>状态</th>
                                                                <th>操作</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <tr>
                                                                <td>2023-11-15 08:23</td>
                                                                <td>水质异常</td>
                                                                <td>区域A-3</td>
                                                                <td>pH值突然下降至6.2</td>
                                                                <td><span class="badge bg-danger">未处理</span></td>
                                                                <td>
                                                                    <button class="btn btn-sm btn-primary">处理</button>
                                                                    <button class="btn btn-sm btn-secondary">详情</button>
                                                                </td>
                                                            </tr>
                                                            <tr>
                                                                <td>2023-11-15 07:45</td>
                                                                <td>设备异常</td>
                                                                <td>区域B-2</td>
                                                                <td>水下摄像头UW002信号不稳定</td>
                                                                <td><span class="badge bg-warning">处理中</span></td>
                                                                <td>
                                                                    <button class="btn btn-sm btn-primary">处理</button>
                                                                    <button class="btn btn-sm btn-secondary">详情</button>
                                                                </td>
                                                            </tr>
                                                            <tr>
                                                                <td>2023-11-14 22:10</td>
                                                                <td>鱼群异常</td>
                                                                <td>区域C-5</td>
                                                                <td>鱼群密度异常增加</td>
                                                                <td><span class="badge bg-warning">处理中</span></td>
                                                                <td>
                                                                    <button class="btn btn-sm btn-primary">处理</button>
                                                                    <button class="btn btn-sm btn-secondary">详情</button>
                                                                </td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 鱼类智能识别 -->
                                <div class="row mt-4">
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header bg-info text-white">
                                                <h5><i class="bi bi-camera-fill me-2"></i>鱼类智能识别</h5>
                                            </div>
                                            <div class="card-body">
                                                <div class="mb-3">
                                                    <div class="input-group">
                                                        <input type="file" class="form-control" id="fishImageUpload">
                                                        <button class="btn btn-primary" id="analyzeFishImage">分析图像</button>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <div class="border p-2 mb-3" style="height: 200px; background-color: #f8f9fa; display: flex; align-items: center; justify-content: center;">
                                                            <span class="text-muted">上传图片预览区</span>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="card">
                                                            <div class="card-header">识别结果</div>
                                                            <div class="card-body">
                                                                <p>请上传鱼类图片进行智能识别</p>
                                                                <div id="recognitionResults" style="display: none;">
                                                                    <div class="mb-2">
                                                                        <strong>鱼类种类:</strong> <span id="fishSpecies">-</span>
                                                                    </div>
                                                                    <div class="mb-2">
                                                                        <strong>可信度:</strong> <span id="recognitionConfidence">-</span>
                                                                    </div>
                                                                    <div class="mb-2">
                                                                        <strong>估计大小:</strong> <span id="fishSize">-</span>
                                                                    </div>
                                                                    <div class="mb-2">
                                                                        <strong>健康状况:</strong> <span id="fishHealth">-</span>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- 水质智能分析 -->
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header bg-primary text-white">
                                                <h5><i class="bi bi-droplet-half me-2"></i>水质智能分析</h5>
                                            </div>
                                            <div class="card-body">
                                                <div class="mb-3">
                                                    <label for="waterAreaSelect" class="form-label">选择区域</label>
                                                    <select class="form-select" id="waterAreaSelect">
                                                        <option value="all">全部区域</option>
                                                        <option value="areaA">区域A</option>
                                                        <option value="areaB">区域B</option>
                                                        <option value="areaC">区域C</option>
                                                    </select>
                                                </div>
                                                <div class="card mb-3">
                                                    <div class="card-body">
                                                        <h6 class="card-title">水质综合评分</h6>
                                                        <div class="progress mb-2" style="height: 25px;">
                                                            <div class="progress-bar bg-success" role="progressbar" style="width: 85%;" aria-valuenow="85" aria-valuemin="0" aria-valuemax="100">85分 - 优良</div>
                                                        </div>
                                                        <div class="small text-muted">最近更新: 2023-11-15 10:30</div>
                                                    </div>
                                                </div>
                                                <div class="alert alert-primary">
                                                    <h6><i class="bi bi-lightbulb-fill me-2"></i>智能建议</h6>
                                                    <ul class="mb-0">
                                                        <li>区域A的溶解氧含量略低，建议增加曝气设备运行时间</li>
                                                        <li>区域C的pH值波动较大，建议检查水质调节系统</li>
                                                        <li>整体水质状况良好，适合当前养殖鱼类生长</li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                    </div>


                                    <!-- 鱼类运动轨迹追踪 -->
                                    <div class="col-md-12 mt-4">
                                        <div class="card">
                                            <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                                                <h5><i class="bi bi-map-fill me-2"></i>鱼类运动轨迹追踪</h5>
                                                <button class="btn btn-sm btn-light" id="downloadFishMovement">
                                                    <i class="bi bi-download"></i> 导出图表
                                                </button>
                                            </div>
                                            <div class="card-body">
                                                <canvas id="fishMovementChart" height="300"></canvas>
                                                <div class="alert alert-secondary mt-3">
                                                    <strong>说明:</strong> 实时跟踪摄像设备所捕捉的鱼群路径，可用于分析鱼类活动习性及区域健康状况。
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- 智能养殖建议 -->
                                    <div class="col-md-12 mt-4">
                                        <div class="card">
                                            <div class="card-header bg-success text-white">
                                                <h5><i class="bi bi-lightbulb-fill me-2"></i>个性化养殖建议生成</h5>
                                            </div>
                                            <div class="card-body">
                                                <button class="btn btn-outline-success mb-3" id="generateAdvice">
                                                    <i class="bi bi-magic"></i> 生成建议
                                                </button>
                                                <div id="adviceResult" class="alert alert-success" style="display: none;">
                                                    <ul>
                                                        <li>建议加强区域B的光照控制，有利于草鱼夜间进食。</li>
                                                        <li>预计8月为高产期，应提前加大饲料投放与巡检频次。</li>
                                                        <li>区域C水温略高，推荐开启温控系统以稳定水温。</li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                    </div>                                    
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/intelligence.js"></script>

    <!-- 添加智能预测相关的JavaScript -->
    <script>
        /**
         * @param {string} canvasId - a canvas's id
         * @param {string} filename - the file's name
         */
        function downloadChart(canvasId, filename) {
            const chartInstance = Chart.getChart(canvasId);
            if (chartInstance) {
                const url = chartInstance.toBase64Image('image/png', 1);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } else {
                console.error('无法找到图表实例:', canvasId);
                alert('下载失败，无法找到图表实例。');
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            // 水质趋势预测图表
            const waterQualityCtx = document.getElementById('waterQualityPredictionChart').getContext('2d');
            const waterQualityChart = new Chart(waterQualityCtx, {
                type: 'line',
                data: {
                    labels: ['6月10日', '6月11日', '6月12日', '6月13日', '6月14日', '6月15日', '6月16日'],
                    datasets: [
                        {
                            label: 'pH值',
                            data: [7.2, 7.3, 7.2, 7.1, 7.0, 6.8, 7.0],
                            borderColor: 'rgba(75, 192, 192, 1)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            tension: 0.1,
                            fill: true
                        },
                        {
                            label: '溶解氧(mg/L)',
                            data: [8.5, 8.4, 8.6, 8.5, 8.3, 8.2, 8.4],
                            borderColor: 'rgba(54, 162, 235, 1)',
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            tension: 0.1,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: '未来7天水质参数预测'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false
                        }
                    }
                }
            });
            
            // 鱼类数量预测图表
            const fishCountCtx = document.getElementById('fishCountPredictionChart').getContext('2d');
            const fishCountChart = new Chart(fishCountCtx, {
                type: 'bar',
                data: {
                    labels: ['6月', '7月', '8月', '9月', '10月', '11月'],
                    datasets: [
                        {
                            label: '鲈鱼预测数量(吨)',
                            data: [12, 15, 18, 16, 14, 13],
                            backgroundColor: 'rgba(255, 99, 132, 0.5)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 1
                        },
                        {
                            label: '草鱼预测数量(吨)',
                            data: [8, 10, 13, 15, 14, 12],
                            backgroundColor: 'rgba(54, 162, 235, 0.5)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: '未来6个月鱼类产量预测'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '数量(吨)'
                            }
                        }
                    }
                }
            });
            
            // 模拟鱼类识别功能
            document.getElementById('analyzeFishImage').addEventListener('click', function() {
                const fileInput = document.getElementById('fishImageUpload');
                if (fileInput.files.length > 0) {
                    // 显示识别结果区域
                    document.getElementById('recognitionResults').style.display = 'block';
                    
                    // 模拟识别结果
                    document.getElementById('fishSpecies').textContent = '鲈鱼 (Lateolabrax japonicus)';
                    document.getElementById('recognitionConfidence').textContent = '92%';
                    document.getElementById('fishSize').textContent = '约 35cm';
                    document.getElementById('fishHealth').textContent = '良好';
                    
                    // 提示用户
                    alert('图像分析完成！');
                } else {
                    alert('请先上传鱼类图片！');
                }
            });
            
            // 水质预测时间范围切换
            document.getElementById('waterQualityDay').addEventListener('click', function() {
                waterQualityChart.data.labels = ['上午8点', '上午10点', '中午12点', '下午2点', '下午4点', '下午6点', '晚上8点'];
                waterQualityChart.data.datasets[0].data = [7.2, 7.3, 7.4, 7.3, 7.2, 7.1, 7.0];
                waterQualityChart.data.datasets[1].data = [8.5, 8.6, 8.7, 8.6, 8.5, 8.4, 8.3];
                waterQualityChart.options.plugins.title.text = '今日水质参数预测';
                waterQualityChart.update();
            });
            
            document.getElementById('waterQualityWeek').addEventListener('click', function() {
                waterQualityChart.data.labels = ['6月10日', '6月11日', '6月12日', '6月13日', '6月14日', '6月15日', '6月16日'];
                waterQualityChart.data.datasets[0].data = [7.2, 7.3, 7.2, 7.1, 7.0, 6.8, 7.0];
                waterQualityChart.data.datasets[1].data = [8.5, 8.4, 8.6, 8.5, 8.3, 8.2, 8.4];
                waterQualityChart.options.plugins.title.text = '未来7天水质参数预测';
                waterQualityChart.update();
            });
            
            document.getElementById('waterQualityMonth').addEventListener('click', function() {
                waterQualityChart.data.labels = ['6月', '7月', '8月', '9月', '10月', '11月', '12月'];
                waterQualityChart.data.datasets[0].data = [7.2, 7.1, 7.0, 6.9, 7.0, 7.1, 7.2];
                waterQualityChart.data.datasets[1].data = [8.5, 8.3, 8.0, 7.8, 8.0, 8.2, 8.4];
                waterQualityChart.options.plugins.title.text = '未来6个月水质参数预测';
                waterQualityChart.update();
            });
            
            // 鱼类数量预测时间范围切换
            document.getElementById('fishCountQuarter').addEventListener('click', function() {
                fishCountChart.data.labels = ['6月', '7月', '8月'];
                fishCountChart.data.datasets[0].data = [12, 15, 18];
                fishCountChart.data.datasets[1].data = [8, 10, 13];
                fishCountChart.options.plugins.title.text = '未来3个月鱼类产量预测';
                fishCountChart.update();
            });
            
            document.getElementById('fishCountHalfYear').addEventListener('click', function() {
                fishCountChart.data.labels = ['6月', '7月', '8月', '9月', '10月', '11月'];
                fishCountChart.data.datasets[0].data = [12, 15, 18, 16, 14, 13];
                fishCountChart.data.datasets[1].data = [8, 10, 13, 15, 14, 12];
                fishCountChart.options.plugins.title.text = '未来6个月鱼类产量预测';
                fishCountChart.update();
            });
            
            document.getElementById('fishCountYear').addEventListener('click', function() {
                fishCountChart.data.labels = ['6月', '8月', '10月', '12月', '2月', '4月'];
                fishCountChart.data.datasets[0].data = [12, 18, 14, 10, 8, 15];
                fishCountChart.data.datasets[1].data = [8, 13, 14, 9, 6, 11];
                fishCountChart.options.plugins.title.text = '未来一年鱼类产量预测';
                fishCountChart.update();
            });
            
            // 导出预测报告
            document.getElementById('exportWaterPrediction').addEventListener('click', function() {
                alert('水质预测报告导出功能已触发');
            });
            
            document.getElementById('exportFishPrediction').addEventListener('click', function() {
                alert('鱼类数量预测报告导出功能已触发');
            });

            document.getElementById('downloadWaterPrediction').addEventListener('click', function() {
                downloadChart('waterQualityPredictionChart', '水质趋势预测图.png');
            });

            document.getElementById('downloadFishCountPrediction').addEventListener('click', function() {
                downloadChart('fishCountPredictionChart', '鱼类数量预测图.png');
            });

            document.getElementById('downloadFishMovement').addEventListener('click', function() {
                downloadChart('fishMovementChart', '鱼类运动轨迹图.png');
            });

            document.getElementById('downloadWaterPredictionBtn').addEventListener('click', function() {
                downloadChart('waterQualityPredictionChart', '水质趋势预测图.png');
            });

            // 鱼类运动轨迹追踪图表
            const fishMovementCtx = document.getElementById('fishMovementChart').getContext('2d');
            const fishMovementChart = new Chart(fishMovementCtx, {
                type: 'line',
                data: {
                    labels: ['区域A', '区域B', '区域C', '区域D', '区域E'],
                    datasets: [
                        {
                            label: '鲈鱼轨迹路径',
                            data: [0, 2, 4, 3, 5], // 模拟“热度”或数量变化
                            borderColor: 'rgba(255, 206, 86, 1)',
                            backgroundColor: 'rgba(255, 206, 86, 0.2)',
                            fill: true,
                            tension: 0.3
                        },
                        {
                            label: '武昌鱼轨迹路径',
                            data: [1, 3, 5, 2, 4], // 模拟“热度”或数量变化
                            borderColor: 'rgba(75, 192, 192, 1)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            fill: true,
                            tension: 0.3
                        },
                        {
                            label: '狗鱼轨迹路径',
                            data: [2, 4, 6, 1, 3], // 模拟“热度”或数量变化
                            borderColor: 'rgba(153, 102, 255, 1)',
                            backgroundColor: 'rgba(153, 102, 255, 0.2)',
                            fill: true,
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: '鱼类在各区域活动轨迹'
                        }
                    },
                    scales: {
                        y: {
                            title: {
                                display: true,
                                text: '检测频次/热度'
                            }
                        }
                    }
                }
            });
            // 生成智能养殖建议
            document.getElementById('generateAdvice').addEventListener('click', function () {
            document.getElementById('adviceResult').style.display = 'block';
            });
            
            // 智能问答模块功能
            let doubaoApiKey = '';
            
            // 保存API Key
            document.getElementById('saveApiKey').addEventListener('click', function() {
                const apiKeyInput = document.getElementById('doubaoApiKey');
                const apiKey = apiKeyInput.value.trim();
                
                if (apiKey) {
                    doubaoApiKey = apiKey;
                    document.getElementById('apiKeyStatus').textContent = '已配置';
                    document.getElementById('apiKeyStatus').className = 'badge bg-success';
                    document.getElementById('userQuestion').disabled = false;
                    document.getElementById('sendQuestion').disabled = false;
                    
                    // 启用快捷问题按钮
                    document.querySelectorAll('.quick-question').forEach(btn => {
                        btn.disabled = false;
                    });
                    
                    // 更新欢迎消息
                    document.getElementById('chatContainer').innerHTML = `
                        <div class="welcome-message text-center text-muted mt-5">
                            <i class="bi bi-robot" style="font-size: 3rem; color: #28a745;"></i>
                            <h5 class="mt-3">海洋牧场智能助手</h5>
                            <p>API配置成功！我已准备好为您解答海洋牧场相关问题。</p>
                            <p class="text-success"><small>您可以开始提问了</small></p>
                        </div>
                    `;
                    
                    alert('API Key配置成功！');
                } else {
                    alert('请输入有效的API Key');
                }
            });
            
            // 发送问题
            document.getElementById('sendQuestion').addEventListener('click', function() {
                sendMessage();
            });
            
            // 回车发送
            document.getElementById('userQuestion').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
            
            // 快捷问题点击
            document.querySelectorAll('.quick-question').forEach(button => {
                button.addEventListener('click', function() {
                    const question = this.getAttribute('data-question');
                    document.getElementById('userQuestion').value = question;
                    sendMessage();
                });
            });
            
            // 发送消息函数
            function sendMessage() {
                const questionInput = document.getElementById('userQuestion');
                const question = questionInput.value.trim();
                
                if (!question) {
                    alert('请输入问题');
                    return;
                }
                
                if (!doubaoApiKey) {
                    alert('请先配置API Key');
                    return;
                }
                
                // 添加用户消息到聊天界面
                addMessageToChat('user', question);
                questionInput.value = '';
                
                // 显示加载状态
                addMessageToChat('assistant', '正在思考中...', true);
                
                // 调用豆包API（这里需要实际的API调用）
                callDoubaoAPI(question);
            }
            
            // 鱼类识别相关功能
            let recognitionHistory = [];
            
            // 初始化鱼类识别功能
            function initFishRecognition() {
                const uploadArea = document.getElementById('uploadArea');
                const fishImageInput = document.getElementById('fishImageInput');
                const imagePreview = document.getElementById('imagePreview');
                const previewImage = document.getElementById('previewImage');
                const analyzeButton = document.getElementById('analyzeButton');
                const clearButton = document.getElementById('clearButton');
                
                // 点击上传区域触发文件选择
                uploadArea.addEventListener('click', () => {
                    fishImageInput.click();
                });
                
                // 拖拽上传功能
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.style.backgroundColor = '#e9ecef';
                });
                
                uploadArea.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    uploadArea.style.backgroundColor = '#f8f9fa';
                });
                
                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.style.backgroundColor = '#f8f9fa';
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        handleImageUpload(files[0]);
                    }
                });
                
                // 文件选择处理
                fishImageInput.addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        handleImageUpload(e.target.files[0]);
                    }
                });
                
                // 开始识别按钮
                analyzeButton.addEventListener('click', () => {
                    analyzeFishImage();
                });
                
                // 清除按钮
                clearButton.addEventListener('click', () => {
                    clearImagePreview();
                });
            }
            
            // 处理图片上传
            function handleImageUpload(file) {
                // 检查文件类型
                if (!file.type.startsWith('image/')) {
                    alert('请上传图片文件');
                    return;
                }
                
                // 检查文件大小（10MB）
                if (file.size > 10 * 1024 * 1024) {
                    alert('图片大小不能超过10MB');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    const previewImage = document.getElementById('previewImage');
                    const imagePreview = document.getElementById('imagePreview');
                    
                    previewImage.src = e.target.result;
                    imagePreview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
            
            // 清除图片预览
            function clearImagePreview() {
                const imagePreview = document.getElementById('imagePreview');
                const fishImageInput = document.getElementById('fishImageInput');
                const recognitionResult = document.getElementById('recognitionResult');
                
                imagePreview.style.display = 'none';
                fishImageInput.value = '';
                
                // 重置识别结果
                recognitionResult.innerHTML = `
                    <div class="text-center text-muted mt-5">
                        <i class="bi bi-fish" style="font-size: 2rem;"></i>
                        <p class="mt-2">请上传鱼类图片进行识别</p>
                    </div>
                `;
            }
            
            // 分析鱼类图片
            function analyzeFishImage() {
                const previewImage = document.getElementById('previewImage');
                const recognitionResult = document.getElementById('recognitionResult');
                const fishImageInput = document.getElementById('fishImageInput');
                
                if (!previewImage.src || !fishImageInput.files[0]) {
                    alert('请先上传图片');
                    return;
                }
                
                // 显示加载状态
                recognitionResult.innerHTML = `
                    <div class="text-center mt-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">识别中...</span>
                        </div>
                        <p class="mt-2">正在识别鱼类，请稍候...</p>
                    </div>
                `;
                
                // 选择使用真实API还是模拟数据
                const useRealAPI = true; // 设置为true使用真实API，false使用模拟数据
                
                if (useRealAPI) {
                    // 调用真实的后端API
                    callFishRecognitionAPI(fishImageInput.files[0]);
                } else {
                    // 使用模拟数据
                    setTimeout(() => {
                        const mockResult = generateMockFishRecognition();
                        displayRecognitionResult(mockResult);
                        addToRecognitionHistory(mockResult);
                    }, 2000);
                }
            }
            
            // 调用鱼类识别API
            function callFishRecognitionAPI(imageFile) {
                const formData = new FormData();
                formData.append('image', imageFile);
                
                fetch('/api/fish-recognition', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        const result = {
                            fishType: data.data.fish_type,
                            confidence: data.data.confidence,
                            predictedLength: data.data.predicted_length,
                            healthScore: data.data.health_score,
                            avgLength: data.data.avg_length,
                            timestamp: data.data.timestamp,
                            recommendations: data.data.recommendations
                        };
                        displayRecognitionResult(result);
                        addToRecognitionHistory(result);
                    } else {
                        displayRecognitionError(data.message);
                    }
                })
                .catch(error => {
                    console.error('识别API调用错误:', error);
                    displayRecognitionError('网络连接异常，请检查网络后重试');
                });
            }
            
            // 显示识别错误
            function displayRecognitionError(message) {
                const recognitionResult = document.getElementById('recognitionResult');
                recognitionResult.innerHTML = `
                    <div class="text-center text-danger mt-5">
                        <i class="bi bi-exclamation-triangle" style="font-size: 2rem;"></i>
                        <p class="mt-2">识别失败</p>
                        <p class="text-muted">${message}</p>
                        <button class="btn btn-outline-primary btn-sm" onclick="analyzeFishImage()">
                            <i class="bi bi-arrow-clockwise"></i> 重试
                        </button>
                    </div>
                `;
            }
            
            // 生成模拟识别结果
            function generateMockFishRecognition() {
                const fishTypes = [
                    { name: '鲈鱼', confidence: 0.92, avgLength: '25-35cm' },
                    { name: '武昌鱼', confidence: 0.88, avgLength: '20-30cm' },
                    { name: '狗鱼', confidence: 0.85, avgLength: '30-45cm' },
                    { name: '鲤鱼', confidence: 0.90, avgLength: '25-40cm' },
                    { name: '草鱼', confidence: 0.87, avgLength: '35-50cm' }
                ];
                
                const randomFish = fishTypes[Math.floor(Math.random() * fishTypes.length)];
                const predictedLength = (Math.random() * 15 + 20).toFixed(1); // 20-35cm
                const healthScore = (Math.random() * 20 + 80).toFixed(1); // 80-100分
                
                return {
                    fishType: randomFish.name,
                    confidence: randomFish.confidence,
                    predictedLength: predictedLength,
                    healthScore: healthScore,
                    avgLength: randomFish.avgLength,
                    timestamp: new Date().toLocaleString()
                };
            }
            
            // 显示识别结果
            function displayRecognitionResult(result) {
                const recognitionResult = document.getElementById('recognitionResult');
                
                recognitionResult.innerHTML = `
                    <div class="recognition-success">
                        <div class="d-flex align-items-center mb-3">
                            <i class="bi bi-check-circle-fill text-success me-2" style="font-size: 1.5rem;"></i>
                            <h6 class="mb-0">识别完成</h6>
                        </div>
                        
                        <div class="result-details">
                            <div class="row mb-2">
                                <div class="col-4"><strong>鱼类品种:</strong></div>
                                <div class="col-8">${result.fishType}</div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-4"><strong>置信度:</strong></div>
                                <div class="col-8">
                                    <span class="badge bg-${result.confidence > 0.9 ? 'success' : result.confidence > 0.8 ? 'warning' : 'secondary'}">
                                        ${(result.confidence * 100).toFixed(1)}%
                                    </span>
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-4"><strong>预测体长:</strong></div>
                                <div class="col-8">${result.predictedLength} cm</div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-4"><strong>健康评分:</strong></div>
                                <div class="col-8">
                                    <span class="badge bg-${result.healthScore > 90 ? 'success' : result.healthScore > 80 ? 'warning' : 'danger'}">
                                        ${result.healthScore}分
                                    </span>
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-4"><strong>标准体长:</strong></div>
                                <div class="col-8">${result.avgLength}</div>
                            </div>
                        </div>
                        
                        <div class="mt-3 p-2 bg-light rounded">
                             <small class="text-muted">
                                 <i class="bi bi-info-circle me-1"></i>
                                 识别时间: ${result.timestamp}
                             </small>
                         </div>
                         
                         ${result.recommendations ? `
                         <div class="mt-3">
                             <h6 class="text-primary"><i class="bi bi-lightbulb me-1"></i>养殖建议</h6>
                             <div class="recommendations p-2 bg-primary bg-opacity-10 rounded">
                                 ${result.recommendations.map(rec => `
                                     <div class="recommendation-item mb-1">
                                         <i class="bi bi-check-circle text-success me-1"></i>
                                         <small>${rec}</small>
                                     </div>
                                 `).join('')}
                             </div>
                         </div>
                         ` : ''}
                     </div>
                 `;
            }
            
            // 添加到识别历史
            function addToRecognitionHistory(result) {
                recognitionHistory.unshift(result);
                
                // 只保留最近10条记录
                if (recognitionHistory.length > 10) {
                    recognitionHistory = recognitionHistory.slice(0, 10);
                }
                
                updateRecognitionHistoryDisplay();
            }
            
            // 更新识别历史显示
            function updateRecognitionHistoryDisplay() {
                const historyContainer = document.getElementById('recognitionHistory');
                
                if (recognitionHistory.length === 0) {
                    historyContainer.innerHTML = '<p class="text-muted text-center">暂无识别记录</p>';
                    return;
                }
                
                const historyHTML = recognitionHistory.map((record, index) => `
                    <div class="history-item p-2 mb-2 border rounded" style="background-color: #f8f9fa;">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${record.fishType}</strong>
                                <span class="badge bg-secondary ms-2">${record.predictedLength}cm</span>
                            </div>
                            <small class="text-muted">${record.timestamp.split(' ')[1]}</small>
                        </div>
                        <div class="mt-1">
                            <small class="text-muted">置信度: ${(record.confidence * 100).toFixed(1)}% | 健康: ${record.healthScore}分</small>
                        </div>
                    </div>
                `).join('');
                
                historyContainer.innerHTML = historyHTML;
            }
            
            // 添加消息到聊天界面
            function addMessageToChat(sender, message, isLoading = false) {
                const chatContainer = document.getElementById('chatContainer');
                
                // 如果是第一条消息，清除欢迎信息
                if (chatContainer.querySelector('.welcome-message')) {
                    chatContainer.innerHTML = '';
                }
                
                const messageDiv = document.createElement('div');
                messageDiv.className = `mb-3 ${sender === 'user' ? 'text-end' : 'text-start'}`;
                
                const messageContent = `
                    <div class="d-inline-block p-3 rounded ${sender === 'user' ? 'bg-primary text-white' : 'bg-light'} ${isLoading ? 'loading-message' : ''}" style="max-width: 70%;">
                        ${sender === 'user' ? '<i class="bi bi-person-fill me-2"></i>' : '<i class="bi bi-robot me-2"></i>'}
                        ${message}
                    </div>
                `;
                
                messageDiv.innerHTML = messageContent;
                chatContainer.appendChild(messageDiv);
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
            
            // 调用智能问答API
            function callDoubaoAPI(question) {
                // 检查API Key是否已配置
                if (!doubaoApiKey) {
                    // 移除加载消息
                    const loadingMessage = document.querySelector('.loading-message');
                    if (loadingMessage) {
                        loadingMessage.parentElement.remove();
                    }
                    addMessageToChat('assistant', '⚠️ 请先配置豆包API Key才能使用智能问答功能。');
                    return;
                }
                
                // 调用后端API
                fetch('/api/doubao-chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        question: question,
                        api_key: doubaoApiKey
                    })
                })
                .then(response => response.json())
                .then(data => {
                    // 移除加载消息
                    const loadingMessage = document.querySelector('.loading-message');
                    if (loadingMessage) {
                        loadingMessage.parentElement.remove();
                    }
                    
                    if (data.error) {
                        addMessageToChat('assistant', `❌ ${data.error}`);
                    } else {
                        addMessageToChat('assistant', data.response);
                    }
                })
                .catch(error => {
                    console.error('API调用错误:', error);
                    // 移除加载消息
                    const loadingMessage = document.querySelector('.loading-message');
                    if (loadingMessage) {
                        loadingMessage.parentElement.remove();
                    }
                    
                    addMessageToChat('assistant', '❌ 网络连接异常，请检查网络后重试。');
                });
            }
            
            // 初始化鱼类识别功能
            initFishRecognition();
        });
    </script>